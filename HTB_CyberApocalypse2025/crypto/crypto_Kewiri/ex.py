#!/usr/bin/env python3

from pwn import *
from sympy import factorint

context.log_level = 'debug'

sla = lambda t, x: r.sendlineafter(t, x)

p = 21214334341047589034959795830530169972304000967355896041112297190770972306665257150126981587914335537556050020788061
f = factorint(p - 1)

r = remote("94.237.53.146", 54064)
r.recvuntil("prime: p = ")
# prime = int(r.recvline().decode().strip('\n'))
log.info(f"Prime: {p}")

p_length = p.bit_length()
log.info(f"length: {p_length}")
sla("> ", str(p_length))

# f = factorint(prime - 1)
# answer_2 = "_".join(f"{prime},{exp}" for prime,exp in sorted(f.items()))
answer_2 = "2,2_5,1_635599,1_2533393,1_4122411947,1_175521834973,1_206740999513,1_1994957217983,1_215264178543783483824207,1_10254137552818335844980930258636403,1"
sla("> ", answer_2)

r.recvline()

for i in range(17):
    g = int(r.recvuntil("?")[:-1].decode())
    answer_x = 1 if all(pow(g, (p - 1)// q, p) != 1 for q in f) else 0
    sla("> ", str(answer_x))
    sleep(0.1)

"""
p = 2121433434...50020788061
a = 4081791555...601351140
b = 8133402404...3976390134

E = EllipticCurve(GF(p), [a, b])
E.order()

=> sagecell.sagemath.org
"""
answer_4 = "21214334341047589034959795830530169972304000967355896041112297190770972306665257150126981587914335537556050020788061"
sla("> ", answer_4)

"""
p = int("21214334341047589034959795830530169972304000967355896041112297190770972306665257150126981587914335537556050020788061")
a = int("408179155510362278173926919850986501979230710105776636663982077437889191180248733396157541580929479690947601351140")
b = int("8133402404274856939573884604662224089841681915139687661374894548183248327840533912259514444213329514848143976390134")

E = EllipticCurve(GF(p), [a, b])
N = E.order(extension=3)

print("_".join(f"{q},{e}" for q,e in sorted(N.factor().items())))
"""
answer_5 = "2,2_7,2_2296163171090566549378609985715193912396821929882292947886890025295122370435191839352044293887595879123562797851002485690372901374381417938210071827839043175382685244226599901222328480132064138736290361668527861560801378793266019,1"
sla("> ", answer_5)

r.interactive()
